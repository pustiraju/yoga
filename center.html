<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" sizes="16x16" href="/images/logo.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/images/logo.png" />
  <title>Organisation/Center Registration Form</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="flex items-center justify-center min-h-screen bg-gray-100">
  <div class="bg-gradient-to-b from-indigo-50 to-purple-50 p-6 sm:p-8 rounded-xl shadow-lg w-full max-w-6xl mx-auto">
    <!-- Banner -->
    <div class="relative w-full h-36 bg-gradient-to-br from-green-600 to-red-600 flex flex-col items-center justify-center text-center rounded-lg shadow-lg mx-auto">
      <h1 class="text-5xl sm:text-6xl font-serif text-yellow-600 drop-shadow-md underline">Yoga Samadhan</h1>
      <p class="text-lg text-amber-100 mt-1"></p>
      <div class="hidden md:block absolute top-1/2 right-10 w-20 h-20 bg-[url('/images/logo.png')] bg-no-repeat bg-center bg-contain opacity-100 -translate-y-1/2"></div>
    </div>
    <!-- Heading -->
    <h2 class="text-2xl sm:text-3xl font-bold text-center text-indigo-900 mb-6">Organisation/Center Registration Form</h2>
    <!-- Form -->
    <form id="registrationForm" action="https://script.google.com/macros/s/AKfycbzns9id0YM4qL4ODc8SmvqmLytnLge6CESY7oW6YJYxRvdk1YFUVWOmWuPsU-K1WdPR/exec" method="POST" enctype="multipart/form-data">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Org Name -->
        <div>
          <label for="org_name" class="block text-sm font-medium text-indigo-800">Organisation / Center Name</label>
          <input type="text" id="org_name" name="org_name" required class="mt-1 w-full p-2 border border-purple-300 rounded-md shadow-sm focus:ring focus:ring-purple-500 bg-white" />
        </div>
        <!-- Established Date -->
        <div>
          <label for="established_date" class="block text-sm font-medium text-indigo-800">Established Date</label>
          <input type="date" id="established_date" name="established_date" required class="mt-1 w-full p-2 border border-purple-300 rounded-md shadow-sm focus:ring focus:ring-purple-500 bg-white" />
        </div>
        <!-- Address -->
        <div class="lg:col-span-2">
          <label for="org_address" class="block text-sm font-medium text-indigo-800">Full Address</label>
          <textarea id="org_address" name="org_address" rows="4" required class="mt-1 w-full p-2 border border-purple-300 rounded-md shadow-sm focus:ring focus:ring-purple-500 bg-white"></textarea>
        </div>
        <!-- Govt Registered -->
        <div class="lg:col-span-2">
          <label class="block text-sm font-medium text-indigo-800 mb-2">Is the Organisation Govt. Registered?</label>
          <div class="flex flex-col lg:flex-row gap-4">
            <label class="flex items-center gap-2">
              <input type="radio" name="govt_registered" value="yes" id="govt_registered_yes" required onchange="toggleRegistrationNumber()" class="text-purple-600" />
              <span class="text-indigo-700 text-sm">Yes</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="radio" name="govt_registered" value="no" id="govt_registered_no" onchange="toggleRegistrationNumber()" class="text-purple-600" />
              <span class="text-indigo-700 text-sm">No</span>
            </label>
            <div id="registration_number_field" class="hidden flex-1">
              <label for="registration_number" class="block text-sm font-medium text-indigo-800">Registration Number</label>
              <input type="text" id="registration_number" name="registration_number" class="mt-1 w-full p-2 border border-purple-300 rounded-md shadow-sm bg-white" />
            </div>
          </div>
        </div>
        <!-- Coach Name -->
        <div>
          <label for="coach_name" class="block text-sm font-medium text-indigo-800">Coach Name</label>
          <input type="text" id="coach_name" name="coach_name" required class="mt-1 w-full p-2 border border-purple-300 rounded-md shadow-sm bg-white" />
        </div>
        <!-- Coach Contact -->
        <div>
          <label for="coach_contact" class="block text-sm font-medium text-indigo-800">Coach Contact No</label>
          <input type="tel" id="coach_contact" name="coach_contact" required class="mt-1 w-full p-2 border border-purple-300 rounded-md shadow-sm bg-white" />
        </div>
        <!-- Coach Address -->
        <div class="lg:col-span-2">
          <label for="coach_address" class="block text-sm font-medium text-indigo-800">Coach Address</label>
          <textarea id="coach_address" name="coach_address" rows="4" required class="mt-1 w-full p-2 border border-purple-300 rounded-md shadow-sm bg-white"></textarea>
        </div>
        <!-- Students -->
        <div>
          <label for="total_students" class="block text-sm font-medium text-indigo-800">Total Students</label>
          <input type="number" id="total_students" name="total_students" min="0" required class="mt-1 w-full p-2 border border-purple-300 rounded-md shadow-sm bg-white" />
        </div>
        <!-- Exam Conducted -->
        <div class="lg:col-span-2">
          <label class="block text-sm font-medium text-indigo-800 mb-2">Has the Organisation conducted exams before?</label>
          <div class="flex flex-col lg:flex-row gap-4">
            <label class="flex items-center gap-2">
              <input type="radio" name="exam_conducted" value="yes" id="exam_conducted_yes" required onchange="toggleExamYears()" class="text-purple-600" />
              <span class="text-indigo-700 text-sm">Yes</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="radio" name="exam_conducted" value="no" id="exam_conducted_no" onchange="toggleExamYears()" class="text-purple-600" />
              <span class="text-indigo-700 text-sm">No</span>
            </label>
            <div id="exam_years_field" class="hidden flex-1">
              <label for="exam_years" class="block text-sm font-medium text-indigo-800">How many years?</label>
              <input type="number" id="exam_years" name="exam_years" min="0" class="mt-1 w-full p-2 border border-purple-300 rounded-md shadow-sm bg-white" />
            </div>
          </div>
        </div>
        <!-- Coach Photo Upload -->
        <div class="lg:col-span-2">
          <label class="block text-sm font-medium text-indigo-800">Upload Coach Photo</label>
          <div id="coach_photo_drop" class="cursor-pointer p-4 border-2 border-dashed border-purple-400 rounded-md bg-purple-100 text-center hover:bg-purple-200 transition">
            <p class="text-sm text-indigo-700">Drag & drop or click to select</p>
            <input type="file" id="coach_photo" name="coach_photo" accept="image/*" class="hidden" />
          </div>
          <div id="coach_photo_preview" class="hidden mt-2">
            <img src="" class="w-full h-auto rounded-md border-2 border-purple-300" />
          </div>
        </div>
        <!-- Org Logo Upload -->
        <div class="lg:col-span-2">
          <label class="block text-sm font-medium text-indigo-800">Upload Organisation Logo</label>
          <div id="org_logo_drop" class="cursor-pointer p-4 border-2 border-dashed border-purple-400 rounded-md bg-purple-100 text-center hover:bg-purple-200 transition">
            <p class="text-sm text-indigo-700">Drag & drop or click to select</p>
            <input type="file" id="org_logo" name="org_logo" accept="image/*" class="hidden" />
          </div>
          <div id="org_logo_preview" class="hidden mt-2">
            <img src="" class="w-full h-auto rounded-md border-2 border-purple-300" />
          </div>
        </div>
        <!-- Declaration -->
        <div class="lg:col-span-2">
          <label class="flex items-start gap-2">
            <input type="checkbox" id="declaration" name="declaration" required class="h-5 w-5 text-purple-600 mt-1" />
            <span class="text-sm text-indigo-700">I certify that all provided information is true and I accept responsibility for any mismatches.</span>
          </label>
        </div>
        <!-- Submit -->
        <div class="lg:col-span-2 text-center">
          <button type="submit" id="submitButton" class="w-full bg-purple-600 text-white px-6 py-3 rounded-md hover:bg-purple-700 focus:ring-2 focus:ring-purple-500 transition">Submit</button>
        </div>
      </div>
    </form>
  </div>
  <!-- Scripts -->
  <script>
    let isSubmitting = false;
    let lastSubmissionTime = 0;
    const DEBOUNCE_MS = 2000;
    function toggleRegistrationNumber() {
      const show = document.getElementById('govt_registered_yes').checked;
      const field = document.getElementById('registration_number_field');
      field.classList.toggle('hidden', !show);
      document.getElementById('registration_number').required = show;
    }
    function toggleExamYears() {
      const show = document.getElementById('exam_conducted_yes').checked;
      const field = document.getElementById('exam_years_field');
      const input = document.getElementById('exam_years');
      field.classList.toggle('hidden', !show);
      input.required = show;
      input.disabled = !show;
      if (!show) {
        input.value = '';
        input.removeAttribute('required'); // Explicitly remove required
      }
    }
    function setupDragAndDrop(dropId, inputId, previewId) {
      const dropZone = document.getElementById(dropId);
      const input = document.getElementById(inputId);
      const preview = document.getElementById(previewId);
      const img = preview.querySelector('img');
      dropZone.addEventListener('dragover', e => {
        e.preventDefault();
        dropZone.classList.add('bg-purple-200');
      });
      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('bg-purple-200');
      });
      dropZone.addEventListener('drop', e => {
        e.preventDefault();
        dropZone.classList.remove('bg-purple-200');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          input.files = files;
          const reader = new FileReader();
          reader.onload = () => {
            img.src = reader.result;
            preview.classList.remove('hidden');
          };
          reader.readAsDataURL(files[0]);
        }
      });
      dropZone.addEventListener('click', () => input.click());
      input.addEventListener('change', () => {
        if (input.files.length > 0) {
          const reader = new FileReader();
          reader.onload = () => {
            img.src = reader.result;
            preview.classList.remove('hidden');
          };
          reader.readAsDataURL(input.files[0]);
        }
      });
    }
    const form = document.getElementById('registrationForm');
    const handler = e => {
      e.preventDefault();
      e.stopPropagation();
      const currentTime = Date.now();
      if (isSubmitting || (currentTime - lastSubmissionTime) < DEBOUNCE_MS) {
        console.log('Submission blocked: in progress or debounced');
        return;
      }
      isSubmitting = true;
      lastSubmissionTime = currentTime;
      const submitButton = document.getElementById('submitButton');
      submitButton.disabled = true;
      submitButton.textContent = 'Submitting...';
      const formData = new FormData(form);
      const submissionId = Date.now().toString() + '-' + Math.random().toString(36).substr(2, 9);
      formData.set('submission_id', submissionId);
      console.log('Generated submission_id:', submissionId);
      const promises = [];
      const coachPhoto = formData.get('coach_photo');
      if (coachPhoto && coachPhoto.size > 0 && coachPhoto.type.startsWith('image/')) {
        if (coachPhoto.size > 5 * 1024 * 1024) {
          alert('Coach photo is too large (max 5MB).');
          resetForm(submitButton);
          return;
        }
        promises.push(fileToBase64(coachPhoto).then(base64 => {
          formData.set('coach_photo', base64);
          console.log('Coach photo encoded');
        }).catch(err => {
          throw new Error('Failed to process coach photo: ' + err.message);
        }));
      } else {
        formData.delete('coach_photo');
      }
      const orgLogo = formData.get('org_logo');
      if (orgLogo && orgLogo.size > 0 && orgLogo.type.startsWith('image/')) {
        if (orgLogo.size > 5 * 1024 * 1024) {
          alert('Organisation logo is too large (max 5MB).');
          resetForm(submitButton);
          return;
        }
        promises.push(fileToBase64(orgLogo).then(base64 => {
          formData.set('org_logo', base64);
          console.log('Org logo encoded');
        }).catch(err => {
          throw new Error('Failed to process org logo: ' + err.message);
        }));
      } else {
        formData.delete('org_logo');
      }
      formData.delete('declaration');
      // Ensure exam_years is empty when exam_conducted is no
      if (formData.get('exam_conducted') === 'no') {
        formData.set('exam_years', '');
      }
      Promise.all(promises)
        .then(() => {
          console.log('Sending form data:', Object.fromEntries(formData));
          return fetch(form.action, {
            method: 'POST',
            body: new URLSearchParams(formData),
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            redirect: 'manual'
          });
        })
        .then(response => {
          console.log('Response status:', response.status);
          if (!response.ok) {
            throw new Error('Server error: ' + response.status);
          }
          return response.text();
        })
        .then(result => {
          console.log('Server response:', result);
          alert(result);
          if (result.includes('successfully')) {
            form.reset();
            document.getElementById('coach_photo_preview').classList.add('hidden');
            document.getElementById('org_logo_preview').classList.add('hidden');
            document.getElementById('registration_number_field').classList.add('hidden');
            document.getElementById('exam_years_field').classList.add('hidden');
            document.getElementById('exam_years').disabled = true;
          }
          resetForm(submitButton);
        })
        .catch(error => {
          console.error('Submission error:', error.message);
          alert('Error: ' + error.message);
          resetForm(submitButton);
        });
    };
    form.removeEventListener('submit', handler);
    form.addEventListener('submit', handler);
    form.onsubmit = e => {
      e.preventDefault();
      return false;
    };
    function resetForm(submitButton) {
      isSubmitting = false;
      submitButton.disabled = false;
      submitButton.textContent = 'Submit';
    }
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(new Error('File reading failed'));
        reader.readAsDataURL(file);
      });
    }
    setupDragAndDrop('coach_photo_drop', 'coach_photo', 'coach_photo_preview');
    setupDragAndDrop('org_logo_drop', 'org_logo', 'org_logo_preview');
    document.getElementById('exam_years').disabled = true;
  </script>
</body>
</html>